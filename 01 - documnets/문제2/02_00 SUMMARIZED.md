# 문제2 보완(멘토)

## 1. 사용자 흐름(User Flow)

### ▶ **핵심 흐름 (Happy Path)**

| **주체** | **단계** | **설명** |
| --- | --- | --- |
| **사용자** | 1. 처방전 업로드 및 정보 입력 | 카카오 채널 통해 **처방전 사진**, **주소**, **연락처**, **배송 희망시간** 입력 후 **주문 요청** |
| **운영자 (어드민)** | 2. 주문 확인 및 금액 확정 | **신규 주문 확인** → **처방전 검토** → **약국 연락** 및 **금액 확인** → 시스템에 **금액 입력** 및 **입금 요청 알림 발송** |
| **사용자** | 3. 결제 및 주문 확정 | 운영자가 발송한 금액을 확인 후 **계좌 이체/PG 결제** (입금) → 시스템에서 **완료 알림 수신** |
| **운영자 (어드민)** | 4. 상태 변경 및 배송 관리 | 상태 변경 (**결제 완료** → **조제 중** → **배송 대기** → **배송 중** → **완료**) 및 배송 파트너 연동 |
| **사용자** | 5. 배송 완료 및 피드백 | **배송 완료 알림** 수신 → 필요 시 **만족도 평가** |

### ▶**예외 흐름(Exception Flow)**

| **발생 시점** | **원인/조건** | **주체별 조치 사항 (시스템/운영자)** | **사용자 후속 조치** | **최종 상태** |
| --- | --- | --- | --- | --- |
| **주문 접수 직후** | 처방전 이미지 불량, 정보 부족 (글자 흐림, 정보 누락 등) | **시스템/운영자:** 처방전 검토 후, 카카오 알림으로 이미지 **재업로드 요청** 발송. | **사용자:** 요청에 따라 정확한 처방전 이미지를 재업로드. | **재업로드 대기** (N시간 미응답 시 **취소**) |
| **주소 입력/확정 시** | 배송 불가 지역 (제한 구역, 너무 먼 거리 등) | **시스템/운영자:** 주소 입력 시 실시간 또는 운영자 확인 후 **서비스 불가 안내** 알림 발송. | **사용자:** 서비스 이용 불가 안내 확인. | **자동 취소 (CANCELED)** |
| **약국 컨택 후** | 약국 재고 부족 또는 처방약과 대체약품 정보 상이 | **운영자:** 대체약 정보 및 가격 차이 확인 후, 사용자에게 **대체약 정보 및 동의 요청** 알림 발송. | **사용자:** 대체약 동의 (진행) 또는 미동의 (**취소**) 의사 표명. | **사용자 확인 대기** (미동의 시 **취소**) |
| **결제 요청 후** | 입금 요청 알림 후 **N시간 내** 결제 미완료/입금 지연 | **시스템:** 설정된 시간(N시간) 경과 시, **자동으로 주문 취소 처리** 및 카카오 알림 발송. | **사용자:** 자동 취소 알림 확인. (재주문 필요) | **자동 취소 (CANCELED)** |
| **처방전 검토 시** | 처방전의 **유효기간(일반적으로 3일)**이 초과된 경우 | **시스템/운영자:** 유효기간 초과 확인 후, **주문 접수 불가 및 재발급 안내** 알림 발송. | **사용자:** 처방전 재발급 후 재주문. | **접수 불가** (처리 불가) |

## 2. 와이어프레임(텍스트 버전) 요약

요청하신 와이어프레임 내용을 카테고리별로 나누어 표로 정리했습니다.

---

### ▶ 카카오톡 채널 (사용자)

| **구분** | **주요 요소** | **설명** |
| --- | --- | --- |
| **초기 화면/메뉴** | 상단 안내 메시지 | 서비스 이용 방법 및 소개 |
|  | "주문 시작하기" 버튼 | 주문 플로우 진입 버튼 |
| **안내 플로우** | 처방전 업로드 | 처방전 사진 전송 요청 |
|  | 주소 입력 요청 | 약품 수령지 주소 입력 요청 |
|  | 연락처/배송시간 입력 | 사용자 연락처 및 배송 희망시간 입력 요청 |
|  | 결제 안내 | 주문 확정 후 금액 및 결제 정보 안내 |
|  | 주문 접수 안내 | 주문이 성공적으로 접수되었음을 알림 |

**▶ 어드민 – 로그인 페이지**

| **영역** | **주요 요소** |
| --- | --- |
| **입력 필드** | Email |
|  | Password |
| **액션 버튼** | 로그인 버튼 |

▶ 어드민 – 주문 리스트

| **구분** | **주요 요소** | **설명** |
| --- | --- | --- |
| **필터** | 상태 필터 | **다중 선택** 가능하도록 구성 (ex: NEW + UNDER_REVIEW 동시 선택) |
|  | 날짜 필터 | 신청일, **배송 예정일** 기준으로 필터 분리 |
|  | 검색(이름/전화번호) | 검색 결과 **하이라이팅** 기능 제공 |
|  | **추가 필터: 약국명** | 특정 약국으로 처리된 주문만 모아보기 기능 추가 |
| **테이블 컬럼** | 주문 ID, 신청 시간, 사용자, 주소 요약, 상태, 금액, [열기] |  |
|  | **결제 상태** | '금액'과 별도로 **결제 상태(미완료/완료)** 컬럼 추가 (결제 현황 즉시 파악) |
|  | **경과 시간** | 'NEW' 상태로 **경과된 시간** 표시 (SLA(서비스 수준 협약) 관리 용이) |

▶ 어드민 – 주문 상세

| **영역** | **주요 요소** | **보완/추가 설명** |
| --- | --- | --- |
| **좌측 정보** | 사용자 기본정보, 주소, 시간 요청 |  |
|  | **배송 지역 특이사항** | 주소 입력 시 **운영자가 알아야 할 사항** (ex: 공동현관 비밀번호, 건물 입구 찾기 어려움 등) 별도 표시 |
| **중앙 처리** | 처방전 이미지 | **이미지 확대/축소/회전** 기능 필수. **OCR 인식 결과**를 이미지 옆에 표시하여 검토 보조. |
|  | 약국명 입력 | 단순 텍스트 입력 대신, **등록된 약국 리스트**에서 선택. (약국 정보 테이블과 연동) |
|  | 금액 입력 | **조제비 / 배송비** 필드를 분리하여 입력하고, **합계 금액** 자동 계산. |
|  | 메모 | 운영자 간 공유를 위한 **내부 메모** (히스토리 관리) |
| **우측 액션** | 상태 변경 드롭다운 | 상태 변경 시 **Audit Log 자동 기록** 명시. |
|  | "상태 업데이트" 버튼 |  |
|  | 사용자 메시지 발송 버튼 | **발송 메시지 종류**를 버튼으로 분리 (ex: `[입금 요청]` 버튼, `[재업로드 요청]` 버튼)하여 오발송 방지. |
|  | **결제 상태 수동 확인 버튼** | 계좌 이체 시, 입금 내역 확인 후 수동으로 **결제 완료 처리**하는 버튼 추가. |

## 🏗️ 3. 시스템 아키텍처 구조

| **구성 요소** | **상세 역할 및 기능** | **기술적 보완/제안 사항** |
| --- | --- | --- |
| **Client** |  |  |
| 카카오톡 앱 | 사용자 인터페이스 (메시징, 챗봇 플로우) | - |
| 웹 어드민 | 운영자 백오피스 (주문 관리, 상태 변경, 사용자 메시지 발송) | **Frontend Framework** (React, Vue.js 등) 사용 |
| **Backend API** |  |  |
| REST API Server | 핵심 비즈니스 로직, 주문/결제/배송 데이터 CRUD | **인증/인가** (JWT 기반) 적용 |
| Kakao Webhook Receiver | 카카오 서버로부터 사용자 메시지 이벤트 수신 및 초기 처리 |  |
| Asynchronous Worker  | I/O 바운드 작업 처리 (알림톡 발송, 대용량 이미지 처리 등) | **Message Queue** (Redis/RabbitMQ) 연동 |
| **Data Storage** |  |  |
| RDB | 정형 데이터 저장 (User, Order, AdminUser, Log 등) | **PostgreSQL** 또는 **MySQL** 사용, **개인정보 암호화** 적용 |
| File Storage | 처방전 이미지 파일 및 기타 미디어 저장 | **Cloud Object Storage** (AWS S3, Google Cloud Storage) 사용 |
| **Infrastructure & Security**  |  |  |
| **API Gateway** | 클라이언트와 백엔드 API 간 트래픽 관리, 보안, 로드 밸런싱 | **TLS/SSL (HTTPS)** 종료, Rate Limiting 적용 |
| **OCR Service**  | 처방전 이미지에서 텍스트 정보(약품명 등) 인식 | 3rd Party OCR API 또는 자체 ML 모델 연동 |
| **3rd Party Services** |  |  |
| KakaoTalk Messaging API | 알림톡, 친구톡 등 사용자 메시지 발송 | **템플릿 관리** 및 발송 성공/실패 로그 기록 |
| PG (Payment Gateway) | 카드 결제, 가상 계좌 발급, 입금 알림 수신 | 결제 트랜잭션의 **안정적 처리** 로직 설계 |
| 배송 파트너 API | 실시간 배송 추적 연동 및 배송 상태 업데이트 (고도화 시) |  |

## 🗃️ 4. 데이터 모델(ERD 개요)

| **테이블 명** | **주요 역할** | **핵심 필드** | **보완/추가 필드** | **관계 (Relation)** |
| --- | --- | --- | --- | --- |
| **User** | 사용자 기본 정보 | `id` (PK), `kakao_user_id`, `name`, `phone`, `created_at` | `email` , `last_login_at` | 1 (User) : N (Order) |
| **AdminUser** | 어드민 사용자 관리 | `id` (PK), `email`, `password_hash`, `role` | `is_active`, `last_login_at` | 1 (AdminUser) : N (AuditLog) |
| **Order** | 주문 핵심 정보 | `id` (PK), `user_id` (FK), `status`, `address`, `requested_delivery_time`, `total_amount` | `payment_status`, **`pharmacy_name`**, `cancel_reason` | N (User) : 1 (Order)
1 (Order) : N (Image) |
| **PrescriptionImage** | 처방전 이미지 파일 | `id` (PK), `order_id` (FK), `file_url` | **`uploaded_at`** | N (Order) : 1 (Image) |
| **Payment** | 결제 정보 기록 | `id` (PK), `order_id` (FK), `method`, `amount`, `paid_at` | **`pg_transaction_id`**, `bank_account_info` (계좌 이체 시) | 1 (Order) : 1 (Payment) |
| **Delivery** | 배송 상태 및 추적 | `id` (PK), `order_id` (FK), `partner`, `status` | **`tracking_number`**, **`delivery_fee`**, `shipped_at`, `delivered_at` | 1 (Order) : 1 (Delivery) |
| **AuditLog** | 운영자 행동 감사 기록 | `id` (PK), `actor_type`, `actor_id` (FK), `action`, `order_id` (FK), `details`(JSON) | `ip_address` | N (AdminUser) : 1 (AuditLog) |
| **Review (신규)** | 사용자 만족도 평가 | `id` (PK), **`order_id` (FK)**, `rating` (1~5), `content` | `created_at` | 1 (Order) : 1 (Review) |

## 🔁 5. 시퀀스 다이어그램(텍스트)

| **그룹** | **No.** | **주체 (Actor)** | **동작 (Action)** | **상세 설명** |
| --- | --- | --- | --- | --- |
| **A. 주문 접수 및 초기 생성** | 1 | **사용자** ->**카카오** | 처방전 이미지 & 메시지 전송 | 카카오 채널 통해 이미지 및 필요 정보 입력. |
|  | 2 | **카카오** ->**Backend** | Webhook 전송 (`message` event) | 사용자 메시지/이미지 URL을 Backend로 전달. |
|  | 3 | **Backend** | 주문 생성 (`Order.status` = **NEW**) & 이미지 저장 | 초기 주문 정보 DB 저장 및 **Async Worker**에 후처리 요청. |
|  | 4 | **Backend** ->**사용자** | 주소 및 추가 정보 요청 알림 | 후속 정보 입력을 위한 카카오 알림톡 발송. |
| **B. 운영자 검토 및 금액 확정** | 5 | **Backend** ->**Admin Web** | 신규 주문 표시 (UI 업데이트) | 운영자 화면에 **NEW** 상태의 주문 표시. |
|  | 6 | **운영자 (어드민)** | 처방전 검토 및 약국 컨택 | 처방전 확인 후, 약국과 통화하여 최종 금액 확인. |
|  | 7 | **운영자 (어드민)** ->**Backend** | 금액 입력 및 상태 변경 (`UNDER_REVIEW`) | 어드민 화면에서 금액 입력 및 저장. |
|  | 8 | **Backend** ->**사용자** | 결제 금액 및 계좌 정보 알림 | **Kakao Messaging API**를 통해 입금 요청 알림톡 발송. |
| **C. 결제 및 조제/배송 처리** | 9 | **사용자** | 입금/PG 결제 |  |
|  | 10 | **PG사/은행 시스템** ->**Backend** | 결제 완료 알림 (`Webhook`/API) | **Payment** 테이블에 기록, `Order.payment_status` 업데이트. |
|  | 11 | **운영자 (어드민)** | 조제 및 배송 준비 지시 | 상태를 `COMPLETED_PAYMENT` ->`IN_DELIVERY`로 변경, **운송장 번호 입력**. |
|  | 12 | **Backend** ->**사용자** | 배송 시작 알림 | 운송장 번호 포함하여 배송 알림톡 발송. |
|  | 13 | **배송 파트너** | 배송 완료 |  |
| **D. 최종 완료 및 피드백** | 14 | **운영자 (어드민)** | 주문 상태 최종 완료 처리 | `Order.status` ->**COMPLETED**. |
|  | 15 | **Backend** ->**사용자** | 배송 완료 및 만족도 평가 요청 | 서비스 이용 완료 알림과 함께 평가 링크 제공. |

## 🔌 6. API 명세

**1. 인증 (Authentication) API**

| **HTTP 메서드** | **리소스 경로** | **설명** | **요청 (Request Body)** | **응답 (Response Body)** |
| --- | --- | --- | --- | --- |
| **POST** | `/auth/login` | 어드민 사용자 로그인 | `email`, `password` | `access_token` (JWT), `admin_id`, `role` |
| **POST** | `/auth/logout` | 토큰 만료 처리 (선택) | `access_token` | `message: "Logged out successfully"` |

**2. 주문 (Order) API - 관리 및 조회**

| **HTTP 메서드** | **리소스 경로** | **설명** | **요청 (Request Query/Body)** | **응답 (Response Body)** |
| --- | --- | --- | --- | --- |
| **GET** | `/orders` | 주문 리스트 조회 | **Query:** `status`, `start_date`, `end_date`, `search` (이름/전화번호), `limit`, `offset` | `list_of_orders` (요약 정보), `total_count` |
| **GET** | `/orders/{id}` | 특정 주문 상세 조회 | **Path:** `id` (주문 ID) | `order_details` (사용자, 주소, 이미지 URL, 금액 등 전체 정보) |
| **POST** | `/orders` | **[내부용]** 주문 강제 생성 | `user_id`, `address`, `prescription_url` | `order_id`, `status: "NEW"` |
| **PUT** | `/orders/{id}` | 주문 기본 정보 업데이트 | **Path:** `id`, **Body:** `total_amount`, `pharmacy_name`, `memo` | `order_id`, `updated_at` |

**3. 주문 상태 및 액션 API - 핵심 운영 기능**

| **HTTP 메서드** | **리소스 경로** | **설명** | **요청 (Request Body)** | **응답 (Response Body)** |
| --- | --- | --- | --- | --- |
| **POST** | `/orders/{id}/status` | **주문 상태 변경** | **Path:** `id`, **Body:** `status` (NEW, UNDER_REVIEW, IN_DELIVERY 등) | `order_id`, `new_status`, `updated_at` |
| **POST** | `/orders/{id}/message` | 사용자에게 카카오 알림톡 발송 | **Path:** `id`, **Body:** `message_type` (ex: REQUEST_PAYMENT, REQUEST_REUPLOAD), `content` | `message_id`, `status: "SENT"` |
| **POST** | `/orders/{id}/payment/confirm` | **[운영자용]** 수동 결제 완료 처리 | **Path:** `id` | `order_id`, `payment_status: "COMPLETED"` |

**4. Webhook API - 카카오 연동**

| **HTTP 메서드** | **리소스 경로** | **설명** | **요청 (Request Body)** | **응답 (Response Body)** |
| --- | --- | --- | --- | --- |
| **POST** | `/webhook/kakao` | 카카오톡 메시지/이벤트 수신 | **카카오 메시징 플랫폼 규격**에 따른 JSON 데이터 | HTTP Status 200 (Success) |

## ⚙️ 7. 비기능 요구사항(NFR)

**1. 성능 및 확장성 (Performance & Scalability)**

| **항목** | **목표 및 설명** | **측정 지표** |
| --- | --- | --- |
| **API 응답 속도** | 핵심 주문 조회 및 상태 변경 API는 **평균 200ms 이내**로 응답해야 함. | APDEX, p95 Latency (95%의 요청이 200ms 이하) |
| **최대 부하 처리** | POC 단계 종료 후, **동시 사용자 50명** 환경에서 안정적으로 동작해야 함. | TPS (Transaction Per Second) 목표치 달성 |
| **시스템 확장성** | 사용자 증가 시, 주문 처리 시스템은 **수평 확장(Scale-out)**이 가능하도록 설계되어야 함. | AWS Auto Scaling 또는 Kubernetes 기반 배포 가능 여부 |

**2. 보안 (Security)**

| **항목** | **목표 및 설명** | **적용 기술/정책** |
| --- | --- | --- |
| **전송 계층 보안** | 모든 클라이언트-서버 통신은 **HTTPS/TLS 1.2 이상**을 사용해야 함. | SSL 인증서 적용 (Let's Encrypt 또는 유료 인증서) |
| **개인정보 보호** | DB에 저장되는 **민감 정보** (연락처, 주소, 처방전 파일 접근 경로)는 암호화되어야 함. | **양방향 암호화** (AES-256) 적용 |
| **인증 및 권한** | 어드민 접근은 **JWT 기반** 토큰으로 인증하며, 역할 기반 접근 제어 (RBAC)를 통해 권한을 분리해야 함. | Admin 로그인 시 JWT 발급, Middleware에서 Role 검증 |
| **접근 감사** | 개인정보를 조회하거나 주문 상태를 변경한 운영자의 행위는 **Audit Log**에 모두 기록되어야 함. | AuditLog 테이블 사용 및 접근 시간, IP 기록 |

**3. 안정성 및 가용성 (Reliability & Availability)**

| **항목** | **목표 및 설명** | **측정 지표/방안** |
| --- | --- | --- |
| **시스템 가용성** | 핵심 주문 처리 시스템은 **월 99.9%** (월 43분 50초 이하 다운타임) 이상의 가용성을 목표로 함. | Uptime Monitoring (Prometheus/Grafana 등) |
| **에러 정책** | HTTP 상태 코드를 표준에 맞게 사용하여 오류 유형을 명확히 구분해야 함. |  |
|  | - 400/422 | 요청 유효성 오류 (데이터 누락, 형식 오류) |
|  | - 401/403 | 인증/권한 오류 (로그인 필요, 권한 없음) |
|  | - 500 | 서버 오류 (예외 발생, DB 접속 실패 등) |

**4. 운영 및 로깅 (Operation & Logging)**

| **항목** | **목표 및 설명** | **상세 로깅 대상** |
| --- | --- | --- |
| **상태 변경 로깅** | 주문 상태 변경은 변경 주체, 시간, 이전/이후 상태를 상세히 기록해야 함. | 모든 상태 변경 이벤트 (`Order.status` 업데이트) |
| **외부 API 로깅** | 카카오 Webhook 수신 및 알림톡 발송 실패 이력은 재시도를 위해 기록해야 함. | 외부 API 요청/응답 전문, 실패 코드, 재시도 횟수 |
| **에러 및 모니터링** | 서버 애플리케이션의 모든 예외와 경고는 통합 로그 시스템으로 수집되어야 함. | 스택 트레이스 포함한 에러 로그 (ELK Stack 또는 클라우드 로깅 서비스) |

## 🗓️ 8. 스프린트 계획

**Sprint 1 — Backend 기본 구축 + Admin 로그인/CRUD**
**Goal:** Admin 로그인 및 주문 핵심 CRUD 기능 구현을 통한 데이터 기본 구조 확립.

| **ID** | **작업 항목** | **타입** | **우선순위** | **예상(일)** |
| --- | --- | --- | --- | --- |
| BE-1 | 프로젝트 초기 환경 설정 및 CI/CD 기본 세팅 | Tech | High | 1 |
| BE-2 | ERD 확정 및 RDB(PostgreSQL/MySQL) 스키마 설계/적용 | Design | High | 1 |
| BE-3 | Admin 로그인 (JWT 발급) 및 인증 API 구현 | Feature | High | 1.5 |
| BE-4 | 주문(Order), 사용자(User) 기본 **CRUD** API 구현 | Feature | High | 3 |
| BE-5 | File Storage (S3 등) 연동 및 처방전 이미지 업로드 API | Feature | Medium | 1.5 |
| FE-1 | Admin 로그인 페이지 UI 구현 및 JWT 기반 로그인 연동 | Feature | Medium | 1.5 |
| **Total** |  |  |  | **9.5** |

**Sprint 2 — 카카오 연동 및 핵심 주문 흐름 구현**

**Goal:** 카카오톡 Webhook 기반 주문 접수 자동화 및 Admin에서 주문 관리 기능 완성.

| **ID** | **작업 항목** | **타입** | **우선순위** | **예상(일)** |
| --- | --- | --- | --- | --- |
| BE-6 | Kakao Webhook Listener 구현 및 메시지 파싱 로직 | Feature | High | 2 |
| BE-7 | 주문 상태 변경 API 구현 및 **Audit Log** 연동 | Feature | High | 2 |
| BE-8 | **Kakao 알림톡 발송 API** (입금 요청, 배송 시작) 연동 | Feature | High | 2 |
| FE-2 | 주문 리스트 UI (필터/검색 포함) 및 상태별 테이블 구현 | Feature | High | 2 |
| FE-3 | 주문 상세 화면 UI 구현 및 상태 변경/메모 기능 연동 | Feature | High | 2 |
| QA-1 | **핵심 플로우 E2E 테스트** (처방전 업로드 → 상태 변경 $\rightarrow$ 알림) | QA | High | 1.5 |
| **Total** |  |  |  | **11.5** |

**Sprint 3 — 고도화, 결제 연동 및 안정화**

**Goal:** 결제 연동을 통한 비즈니스 흐름 완성 및 시스템 안정성 확보.

| **ID** | **작업 항목** | **타입** | **우선순위** | **예상(일)** |
| --- | --- | --- | --- | --- |
| BE-9 | **PG 연동** 또는 **결제 확인 로직** 및 `Payment` 테이블 처리 구현 | Feature | High | 2.5 |
| BE-10 | 예외 흐름 처리 로직 구현 (재고 부족/사진 불량 알림) | Feature | Medium | 1.5 |
| FE-4 | Admin 내 결제 상태 수동 처리 버튼 및 UX 개선 | Feature | Medium | 1 |
| FE-5 | 사용자 만족도 평가 API 및 Admin 통계 UI (간단) | Feature | Low | 1.5 |
| QA-2 | 전체 시스템 성능 및 부하 테스트 (POC 기준) | QA | High | 1 |
| DOC-1 | 최종 산출물 정리 및 **운영 가이드** 작성 | Management | High | 1 |
| **Total** |  |  |  | **8.5** |